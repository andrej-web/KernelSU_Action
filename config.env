- name: Prepare config.env and export variables
  shell: bash
  run: |
    set -euo pipefail

    # 1) ÐŸÐ¸ÑˆÐµÐ¼ config.env (Ð¾Ð´Ð¸Ð½ Ñ€Ð°Ð·, Ð±ÐµÐ· Ñ€ÑƒÑ‡Ð½Ñ‹Ñ… Ð¼ÑƒÑ‡ÐµÐ½Ð¸Ð¹)
    cat > config.env <<'EOF'
    # ========================================
    # Redmi 10C / fog â€” Ñ€Ð°Ð±Ð¾Ñ‡Ð¸Ð¹ ÐºÐ¾Ð½Ñ„Ð¸Ð³
    # ========================================

    # ðŸ“¦ KERNEL SOURCE
    KERNEL_SOURCE=https://github.com/r0ddty/kernel_xiaomi_fog
    KERNEL_SOURCE_BRANCH=andromeda-mk2
    KERNEL_CONFIG=fog_defconfig
    KERNEL_ZIP_NAME=KernelSU-Makeine-fog.zip
    ARCH=arm64
    KERNEL_IMAGE_NAME=Image.gz-dtb

    # ðŸ”§ KERNELSU
    ENABLE_KERNELSU=true
    KERNELSU_INSTALLER=https://raw.githubusercontent.com/tiann/KernelSU/main/kernel/setup.sh
    KERNELSU_TAG=v0.9.5
    ADD_KPROBES_CONFIG=true
    ADD_OVERLAYFS_CONFIG=true

    # ðŸš€ BOOT IMG (Ð¾Ð±Ðµ Ð¿Ð°Ñ€Ñ‹ Ð¸Ð¼Ñ‘Ð½ â€” Ñ‡Ñ‚Ð¾Ð±Ñ‹ Ð¿Ð¾Ð´Ð¾ÑˆÐ»Ð¾ Ð¿Ð¾Ð´ Ð»ÑŽÐ±Ð¾Ð¹ workflow)
    BUILD_KERNELSU_BOOT_IMG=true
    KERNELSU_SOURCE_BOOT_IMAGE=https://tinyurl.com/fog-boot-image

    BUILD_BOOT_IMG=true
    SOURCE_BOOT_IMAGE=https://tinyurl.com/fog-boot-image

    # ðŸ§° CLANG / TOOLCHAIN
    USE_AOSP_CLANG=false
    AOSP_CLANG_BRANCH=main
    AOSP_CLANG_VERSION=r416183b1

    USE_CUSTOM_CLANG=true
    CUSTOM_CLANG_SOURCE=https://github.com/kdrag0n/proton-clang
    CUSTOM_CLANG_BRANCH=master

    # ðŸ› ï¸ GCC
    USE_CUSTOM_GCC_64=true
    CUSTOM_GCC_64_SOURCE=https://github.com/LineageOS/android_prebuilts_gcc_linux-x86_aarch64_aarch64-linux-android-4.9
    CUSTOM_GCC_64_BRANCH=lineage-19.1
    CUSTOM_GCC_64_BIN=aarch64-linux-android-

    USE_CUSTOM_GCC_32=true
    CUSTOM_GCC_32_SOURCE=https://github.com/LineageOS/android_prebuilts_gcc_linux-x86_arm_arm-linux-androideabi-4.9
    CUSTOM_GCC_32_BRANCH=lineage-19.1
    CUSTOM_GCC_32_BIN=arm-linux-androideabi-

    # âš™ï¸ ÐŸÐ ÐžÐ§Ð•Ð•
    ENABLE_CCACHE=true
    REMOVE_UNUSED_PACKAGES=true
    EXTRA_CMDS=
    EOF

    # 2) ÐÐ° Ð²ÑÑÐºÐ¸Ð¹ ÑÐ»ÑƒÑ‡Ð°Ð¹ ÑƒÐ±Ð¸Ñ€Ð°ÐµÐ¼ Windows-Ð¾ÐºÐ¾Ð½Ñ‡Ð°Ð½Ð¸Ñ ÑÑ‚Ñ€Ð¾Ðº, ÐµÑÐ»Ð¸ Ð³Ð´Ðµ-Ñ‚Ð¾ Ð¿Ñ€Ð¸Ð»ÐµÑ‚ÐµÐ»Ð¸
    sed -i 's/\r$//' config.env

    # 3) Ð­ÐºÑÐ¿Ð¾Ñ€Ñ‚Ð¸Ñ€ÑƒÐµÐ¼ Ð¿ÐµÑ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ðµ Ð´Ð»Ñ Ð’Ð¡Ð•Ð¥ ÑÐ»ÐµÐ´ÑƒÑŽÑ‰Ð¸Ñ… ÑˆÐ°Ð³Ð¾Ð² (Ñ„Ð¸ÐºÑ "Ð¿ÐµÑ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ðµ Ð¿ÑƒÑÑ‚Ñ‹Ðµ")
    while IFS= read -r line; do
      [[ -z "$line" ]] && continue
      [[ "$line" =~ ^[[:space:]]*# ]] && continue
      echo "$line" >> "$GITHUB_ENV"
    done < config.env

    # 4) Ð¡Ñ‚Ñ€Ð°Ñ…Ð¾Ð²ÐºÐ°: Ð´Ð°Ð¶Ðµ ÐµÑÐ»Ð¸ ÐºÐ°ÐºÐ¾Ð¹-Ñ‚Ð¾ workflow Ð¾Ð¶Ð¸Ð´Ð°ÐµÑ‚ ÑÑ‚Ð¸ Ð¸Ð¼ÐµÐ½Ð° â€” Ð¾Ð½Ð¸ Ñ‚Ð¾Ñ‡Ð½Ð¾ Ð½Ðµ Ð±ÑƒÐ´ÑƒÑ‚ Ð¿ÑƒÑÑ‚Ñ‹Ð¼Ð¸
    echo "ENABLE_KERNELSU=${ENABLE_KERNELSU:-true}" >> "$GITHUB_ENV"
    echo "BUILD_KERNELSU_BOOT_IMG=${BUILD_KERNELSU_BOOT_IMG:-true}" >> "$GITHUB_ENV"
    echo "BUILD_BOOT_IMG=${BUILD_BOOT_IMG:-true}" >> "$GITHUB_ENV"
    echo "USE_CUSTOM_CLANG=${USE_CUSTOM_CLANG:-true}" >> "$GITHUB_ENV"
    echo "USE_AOSP_CLANG=${USE_AOSP_CLANG:-false}" >> "$GITHUB_ENV"
