name: Build Kernel with KernelSU
on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Prepare config.env and export variables
        run: |
          cat > config.env <<EOF
          KERNEL_SOURCE=https://github.com/r0ddty/kernel_xiaomi_fog
          KERNEL_SOURCE_BRANCH=andromeda-mk2
          KERNEL_CONFIG=fog_defconfig
          KERNEL_ZIP_NAME=KernelSU-Makeine-fog.zip
          ARCH=arm64
          ENABLE_KERNELSU=true
          KERNELSU_TAG=v0.9.5
          BUILD_BOOT_IMG=true
          SOURCE_BOOT_IMAGE=https://tinyurl.com/fog-boot-image
          USE_CUSTOM_CLANG=true
          CUSTOM_CLANG_SOURCE=https://github.com/kdrag0n/proton-clang
          CUSTOM_CLANG_BRANCH=master
          USE_CUSTOM_GCC_64=true
          CUSTOM_GCC_64_SOURCE=https://github.com/LineageOS/android_prebuilts_gcc_linux-x86_aarch64_aarch64-linux-android-4.9
          CUSTOM_GCC_64_BRANCH=lineage-19.1
          USE_CUSTOM_GCC_32=true
          CUSTOM_GCC_32_SOURCE=https://github.com/LineageOS/android_prebuilts_gcc_linux-x86_arm_arm-linux-androideabi-4.9
          CUSTOM_GCC_32_BRANCH=lineage-19.1
          EOF
          grep -v '^#' config.env | grep -v '^$' >> $GITHUB_ENV

      - name: Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y bc build-essential flex bison lzip libssl-dev libelf-dev clang llvm lld wget curl

      - name: Download Toolchains
        run: |
          mkdir -p $GITHUB_WORKSPACE/kernel_workspace
          git clone ${{ env.CUSTOM_CLANG_SOURCE }} -b ${{ env.CUSTOM_CLANG_BRANCH }} $GITHUB_WORKSPACE/kernel_workspace/clang --depth=1
          git clone ${{ env.CUSTOM_GCC_64_SOURCE }} -b ${{ env.CUSTOM_GCC_64_BRANCH }} $GITHUB_WORKSPACE/kernel_workspace/gcc-64 --depth=1
          git clone ${{ env.CUSTOM_GCC_32_SOURCE }} -b ${{ env.CUSTOM_GCC_32_BRANCH }} $GITHUB_WORKSPACE/kernel_workspace/gcc-32 --depth=1

      - name: Download Kernel Source
        run: |
          cd $GITHUB_WORKSPACE/kernel_workspace
          git clone ${{ env.KERNEL_SOURCE }} -b ${{ env.KERNEL_SOURCE_BRANCH }} android-kernel --depth=1

      - name: Setup KernelSU
        run: |
          cd $GITHUB_WORKSPACE/kernel_workspace/android-kernel
          curl -LSs "https://raw.githubusercontent.com/tiann/KernelSU/main/kernel/setup.sh" | bash -s ${{ env.KERNELSU_TAG }}

      - name: Build Kernel
        run: |
          cd $GITHUB_WORKSPACE/kernel_workspace/android-kernel
          # Явно прописываем пути, не ломая системный PATH
          CLANG_BIN=$GITHUB_WORKSPACE/kernel_workspace/clang/bin
          GCC64_BIN=$GITHUB_WORKSPACE/kernel_workspace/gcc-64/bin
          GCC32_BIN=$GITHUB_WORKSPACE/kernel_workspace/gcc-32/bin
          
          # Формируем аргументы сборки
          MAKE_ARGS="ARCH=${{ env.ARCH }} \
                     O=out \
                     CC=$CLANG_BIN/clang \
                     CLANG_TRIPLE=aarch64-linux-gnu- \
                     CROSS_COMPILE=$GCC64_BIN/aarch64-linux-android- \
                     CROSS_COMPILE_ARM32=$GCC32_BIN/arm-linux-androideabi- \
                     LD=$CLANG_BIN/ld.lld \
                     AR=$CLANG_BIN/llvm-ar \
                     NM=$CLANG_BIN/llvm-nm \
                     OBJCOPY=$CLANG_BIN/llvm-objcopy \
                     OBJDUMP=$CLANG_BIN/llvm-objdump \
                     STRIP=$CLANG_BIN/llvm-strip"

          # 1. Создаем конфиг
          make -j$(nproc) $MAKE_ARGS ${{ env.KERNEL_CONFIG }}
          
          # 2. Запускаем компиляцию
          make -j$(nproc) $MAKE_ARGS

      - name: Patch and Upload
        run: |
          cd $GITHUB_WORKSPACE/kernel_workspace
          wget -O boot-old.img "${{ env.SOURCE_BOOT_IMAGE }}"
          # Ищем собранное ядро и копируем его для загрузки
          find android-kernel/out/arch/arm64/boot/ -name "Image.gz-dtb" -exec cp {} . \;
          find android-kernel/out/arch/arm64/boot/ -name "Image.gz" -exec cp {} . \;

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.KERNEL_ZIP_NAME }}
          path: |
            ${{ github.workspace }}/kernel_workspace/Image.gz*
