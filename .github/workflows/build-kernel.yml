name: Build Kernel with KernelSU
on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Prepare config.env and export variables
        run: |
          # Создаем файл конфигурации внутри процесса
          cat > config.env <<EOF
          KERNEL_SOURCE=https://github.com/r0ddty/kernel_xiaomi_fog
          KERNEL_SOURCE_BRANCH=andromeda-mk2
          KERNEL_CONFIG=fog_defconfig
          KERNEL_ZIP_NAME=KernelSU-Makeine-fog.zip
          ARCH=arm64
          ENABLE_KERNELSU=true
          KERNELSU_TAG=v0.9.5
          BUILD_BOOT_IMG=true
          SOURCE_BOOT_IMAGE=https://tinyurl.com/fog-boot-image
          USE_CUSTOM_CLANG=true
          CUSTOM_CLANG_SOURCE=https://github.com/kdrag0n/proton-clang
          CUSTOM_CLANG_BRANCH=master
          USE_CUSTOM_GCC_64=true
          CUSTOM_GCC_64_SOURCE=https://github.com/LineageOS/android_prebuilts_gcc_linux-x86_aarch64_aarch64-linux-android-4.9
          CUSTOM_GCC_64_BRANCH=lineage-19.1
          USE_CUSTOM_GCC_32=true
          CUSTOM_GCC_32_SOURCE=https://github.com/LineageOS/android_prebuilts_gcc_linux-x86_arm_arm-linux-androideabi-4.9
          CUSTOM_GCC_32_BRANCH=lineage-19.1
          EOF
          # Загружаем переменные в окружение GitHub
          grep -v '^#' config.env | grep -v '^$' >> $GITHUB_ENV

      - name: Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y bc build-essential flex bison lzip libssl-dev libelf-dev clang llvm lld wget curl

      - name: Download Toolchains
        run: |
          mkdir -p $GITHUB_WORKSPACE/kernel_workspace
          git clone ${{ env.CUSTOM_CLANG_SOURCE }} -b ${{ env.CUSTOM_CLANG_BRANCH }} $GITHUB_WORKSPACE/kernel_workspace/clang --depth=1
          git clone ${{ env.CUSTOM_GCC_64_SOURCE }} -b ${{ env.CUSTOM_GCC_64_BRANCH }} $GITHUB_WORKSPACE/kernel_workspace/gcc-64 --depth=1
          git clone ${{ env.CUSTOM_GCC_32_SOURCE }} -b ${{ env.CUSTOM_GCC_32_BRANCH }} $GITHUB_WORKSPACE/kernel_workspace/gcc-32 --depth=1

      - name: Download Kernel Source
        run: |
          cd $GITHUB_WORKSPACE/kernel_workspace
          # УБРАНО --recursive ДЛЯ ОБХОДА ОШИБКИ 128
          git clone ${{ env.KERNEL_SOURCE }} -b ${{ env.KERNEL_SOURCE_BRANCH }} android-kernel --depth=1

      - name: Setup KernelSU
        run: |
          cd $GITHUB_WORKSPACE/kernel_workspace/android-kernel
          curl -LSs "https://raw.githubusercontent.com/tiann/KernelSU/main/kernel/setup.sh" | bash -s ${{ env.KERNELSU_TAG }}

      - name: Build Kernel
        run: |
          cd $GITHUB_WORKSPACE/kernel_workspace/android-kernel
          export PATH=$GITHUB_WORKSPACE/kernel_workspace/clang/bin:$PATH
          export CROSS_COMPILE=$GITHUB_WORKSPACE/kernel_workspace/gcc-64/bin/aarch64-linux-android-
          export CROSS_COMPILE_ARM32=$GITHUB_WORKSPACE/kernel_workspace/gcc-32/bin/arm-linux-androideabi-
          make -j$(nproc) O=out ARCH=${{ env.ARCH }} ${{ env.KERNEL_CONFIG }}
          make -j$(nproc) O=out ARCH=${{ env.ARCH }} CROSS_COMPILE=$CROSS_COMPILE CROSS_COMPILE_ARM32=$CROSS_COMPILE_ARM32 CC=clang CLANG_TRIPLE=aarch64-linux-gnu-

      - name: Patch and Upload
        run: |
          cd $GITHUB_WORKSPACE/kernel_workspace
          wget -O boot-old.img "${{ env.SOURCE_BOOT_IMAGE }}"
          # Здесь скрипт завершает работу и подготавливает артефакт
          cp android-kernel/out/arch/arm64/boot/Image.gz-dtb . || true

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.KERNEL_ZIP_NAME }}
          path: $GITHUB_WORKSPACE/kernel_workspace/*.gz-dtb
