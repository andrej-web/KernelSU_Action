name: Build Kernel with KernelSU
on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Prepare Variables
        run: |
          echo "KERNEL_SOURCE=https://github.com/r0ddty/kernel_xiaomi_fog" >> $GITHUB_ENV
          echo "KERNEL_SOURCE_BRANCH=andromeda-mk2" >> $GITHUB_ENV
          echo "KERNEL_ZIP_NAME=KernelSU-Makeine-fog.zip" >> $GITHUB_ENV
          echo "ARCH=arm64" >> $GITHUB_ENV
          echo "KERNELSU_TAG=v0.9.5" >> $GITHUB_ENV
          echo "SOURCE_BOOT_IMAGE=https://tinyurl.com/fog-boot-image" >> $GITHUB_ENV

      - name: Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y bc build-essential flex bison lzip libssl-dev libelf-dev clang llvm lld wget curl

      - name: Download Toolchains
        run: |
          mkdir -p $GITHUB_WORKSPACE/kernel_workspace
          git clone https://github.com/kdrag0n/proton-clang -b master $GITHUB_WORKSPACE/kernel_workspace/clang --depth=1
          git clone https://github.com/LineageOS/android_prebuilts_gcc_linux-x86_aarch64_aarch64-linux-android-4.9 -b lineage-19.1 $GITHUB_WORKSPACE/kernel_workspace/gcc-64 --depth=1
          git clone https://github.com/LineageOS/android_prebuilts_gcc_linux-x86_arm_arm-linux-androideabi-4.9 -b lineage-19.1 $GITHUB_WORKSPACE/kernel_workspace/gcc-32 --depth=1

      - name: Download Kernel Source
        run: |
          cd $GITHUB_WORKSPACE/kernel_workspace
          git clone ${{ env.KERNEL_SOURCE }} -b ${{ env.KERNEL_SOURCE_BRANCH }} android-kernel --depth=1

      - name: Setup KernelSU
        run: |
          cd $GITHUB_WORKSPACE/kernel_workspace/android-kernel
          curl -LSs "https://raw.githubusercontent.com/tiann/KernelSU/main/kernel/setup.sh" | bash -s ${{ env.KERNELSU_TAG }}

      - name: Build Kernel
        run: |
          cd $GITHUB_WORKSPACE/kernel_workspace/android-kernel
          CLANG_BIN=$GITHUB_WORKSPACE/kernel_workspace/clang/bin
          GCC64_BIN=$GITHUB_WORKSPACE/kernel_workspace/gcc-64/bin
          GCC32_BIN=$GITHUB_WORKSPACE/kernel_workspace/gcc-32/bin
          
          echo "=== СПИСОК ДОСТУПНЫХ КОНФИГОВ (для отладки) ==="
          find arch/arm64/configs/ -name "*defconfig" | sed 's|arch/arm64/configs/||' | head -n 20
          
          # Проверяем по очереди: fog_defconfig -> bengal-perf_defconfig -> bengal_defconfig
          if [ -f "arch/arm64/configs/vendor/fog_defconfig" ]; then
              FINAL_CONFIG="vendor/fog_defconfig"
          elif [ -f "arch/arm64/configs/fog_defconfig" ]; then
              FINAL_CONFIG="fog_defconfig"
          elif [ -f "arch/arm64/configs/vendor/bengal-perf_defconfig" ]; then
              FINAL_CONFIG="vendor/bengal-perf_defconfig"
          elif [ -f "arch/arm64/configs/vendor/bengal_defconfig" ]; then
              FINAL_CONFIG="vendor/bengal_defconfig"
          else
              # Берем первый попавшийся с bengal, если ничего не нашли
              FINAL_CONFIG=$(find arch/arm64/configs/ -name "*bengal*_defconfig" | head -n 1 | sed 's|arch/arm64/configs/||')
          fi

          if [ -z "$FINAL_CONFIG" ]; then echo "КРИТИЧЕСКАЯ ОШИБКА: Конфиг не найден!"; exit 1; fi
          echo "ИСПОЛЬЗУЕМ КОНФИГ: $FINAL_CONFIG"

          MAKE_ARGS="ARCH=arm64 \
                     O=out \
                     CC=$CLANG_BIN/clang \
                     CLANG_TRIPLE=aarch64-linux-gnu- \
                     CROSS_COMPILE=$GCC64_BIN/aarch64-linux-android- \
                     CROSS_COMPILE_ARM32=$GCC32_BIN/arm-linux-androideabi- \
                     LD=$CLANG_BIN/ld.lld \
                     AR=$CLANG_BIN/llvm-ar \
                     NM=$CLANG_BIN/llvm-nm \
                     OBJCOPY=$CLANG_BIN/llvm-objcopy \
                     OBJDUMP=$CLANG_BIN/llvm-objdump \
                     STRIP=$CLANG_BIN/llvm-strip"

          make -j$(nproc) $MAKE_ARGS $FINAL_CONFIG
          make -j$(nproc) $MAKE_ARGS

      - name: Patch and Upload
        run: |
          cd $GITHUB_WORKSPACE/kernel_workspace
          # Ищем результат
          find android-kernel/out/arch/arm64/boot/ -name "Image.gz*" -exec cp {} . \;

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.KERNEL_ZIP_NAME }}
          path: |
            ${{ github.workspace }}/kernel_workspace/Image.gz*
