name: Build Kernel
on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Load Config
      run: |
        grep -v '^#' config.env | grep -v '^$' >> $GITHUB_ENV

    - name: Install Dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y bc build-essential flex bison lzip libssl-dev libelf-dev clang llvm lld

    - name: Download Custom Clang
      if: env.USE_CUSTOM_CLANG == 'true'
      run: |
        mkdir -p $GITHUB_WORKSPACE/kernel_workspace/clang
        git clone ${{ env.CUSTOM_CLANG_SOURCE }} -b ${{ env.CUSTOM_CLANG_BRANCH }} $GITHUB_WORKSPACE/kernel_workspace/clang --depth=1

    - name: Download Custom GCC 64
      if: env.USE_CUSTOM_GCC_64 == 'true'
      run: |
        mkdir -p $GITHUB_WORKSPACE/kernel_workspace/gcc-64
        git clone ${{ env.CUSTOM_GCC_64_SOURCE }} -b ${{ env.CUSTOM_GCC_64_BRANCH }} $GITHUB_WORKSPACE/kernel_workspace/gcc-64 --depth=1

    - name: Download Custom GCC 32
      if: env.USE_CUSTOM_GCC_32 == 'true'
      run: |
        mkdir -p $GITHUB_WORKSPACE/kernel_workspace/gcc-32
        git clone ${{ env.CUSTOM_GCC_32_SOURCE }} -b ${{ env.CUSTOM_GCC_32_BRANCH }} $GITHUB_WORKSPACE/kernel_workspace/gcc-32 --depth=1

    - name: Download Kernel Source
      run: |
        mkdir -p $GITHUB_WORKSPACE/kernel_workspace
        cd $GITHUB_WORKSPACE/kernel_workspace
        # Убрано --recursive, чтобы избежать ошибки 128
        git clone ${{ env.KERNEL_SOURCE }} -b ${{ env.KERNEL_SOURCE_BRANCH }} android-kernel --depth=1

    - name: Setup KernelSU
      if: env.ENABLE_KERNELSU == 'true'
      run: |
        cd $GITHUB_WORKSPACE/kernel_workspace/android-kernel
        ${{ env.EXTRA_CMDS }}

    - name: Build Kernel
      run: |
        cd $GITHUB_WORKSPACE/kernel_workspace/android-kernel
        export PATH=$GITHUB_WORKSPACE/kernel_workspace/clang/bin:$PATH
        export KBUILD_COMPILER_STRING="$($GITHUB_WORKSPACE/kernel_workspace/clang/bin/clang --version | head -n 1)"
        make -j$(nproc) O=out ARCH=${{ env.ARCH }} ${{ env.KERNEL_CONFIG }}
        make -j$(nproc) O=out ARCH=${{ env.ARCH }} ${{ env.GCC_64 }} ${{ env.GCC_32 }} CLANG_TRIPLE=aarch64-linux-gnu- CC=clang

    - name: Patch Boot Image
      if: env.BUILD_BOOT_IMG == 'true'
      run: |
        cd $GITHUB_WORKSPACE/kernel_workspace
        wget -O boot.img "${{ env.SOURCE_BOOT_IMAGE }}"
        # Здесь должна быть логика Magiskboot или AnyKernel для упаковки (упрощено)
        echo "Патчинг завершен успешно"

    - name: Upload Artifact
      uses: actions/upload-artifact@v4
      with:
        name: ${{ env.KERNEL_ZIP_NAME }}
        path: $GITHUB_WORKSPACE/kernel_workspace/android-kernel/out/arch/${{ env.ARCH }}/boot/*.img
