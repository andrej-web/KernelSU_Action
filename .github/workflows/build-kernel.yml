name: Build Kernel with KernelSU

on:
  workflow_dispatch:  # ручной запуск

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Prepare Variables
        run: |
          echo "KERNEL_SOURCE=https://github.com/r0ddty/kernel_xiaomi_fog" >> $GITHUB_ENV
          echo "KERNEL_SOURCE_BRANCH=andromeda-mk2" >> $GITHUB_ENV
          echo "KERNEL_ZIP_NAME=KernelSU-Makeine-fog.zip" >> $GITHUB_ENV
          echo "ARCH=arm64" >> $GITHUB_ENV
          echo "KERNELSU_TAG=v0.9.5" >> $GITHUB_ENV
          echo "SOURCE_BOOT_IMAGE=https://tinyurl.com/fog-boot-image" >> $GITHUB_ENV
          # Если автоматический выбор defconfig не подходит, раскомментируйте и укажите нужное имя:
          # echo "MANUAL_DEFCONFIG=vendor/bengal-perf_defconfig" >> $GITHUB_ENV

      - name: Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y bc build-essential flex bison lzip libssl-dev libelf-dev clang llvm lld wget curl cpio

      - name: Download Toolchains (Proton Clang)
        run: |
          mkdir -p $GITHUB_WORKSPACE/kernel_workspace
          git clone https://github.com/kdrag0n/proton-clang -b master $GITHUB_WORKSPACE/kernel_workspace/clang --depth=1
          # GCC больше не нужны, используем чистый Clang (LLVM=1)

      - name: Download Kernel Source
        run: |
          cd $GITHUB_WORKSPACE/kernel_workspace
          git clone ${{ env.KERNEL_SOURCE }} -b ${{ env.KERNEL_SOURCE_BRANCH }} android-kernel --depth=1

      - name: Setup KernelSU
        run: |
          cd $GITHUB_WORKSPACE/kernel_workspace/android-kernel
          curl -LSs "https://raw.githubusercontent.com/tiann/KernelSU/main/kernel/setup.sh" | bash -s ${{ env.KERNELSU_TAG }}

      - name: Select Defconfig
        id: defconfig
        run: |
          cd $GITHUB_WORKSPACE/kernel_workspace/android-kernel
          echo "=== Доступные defconfig ==="
          find arch/arm64/configs/ -type f -name "*defconfig*" | sed 's|arch/arm64/configs/||' | sort

          # Если задан ручной defconfig, используем его
          if [ -n "$MANUAL_DEFCONFIG" ]; then
            echo "Используется ручной defconfig: $MANUAL_DEFCONFIG"
            echo "FINAL_CONFIG=$MANUAL_DEFCONFIG" >> $GITHUB_OUTPUT
            exit 0
          fi

          # Автоматический поиск (приоритет: fog, затем bengal)
          if [ -f "arch/arm64/configs/vendor/fog_defconfig" ]; then
            FINAL="vendor/fog_defconfig"
          elif [ -f "arch/arm64/configs/fog_defconfig" ]; then
            FINAL="fog_defconfig"
          elif [ -f "arch/arm64/configs/vendor/bengal-perf_defconfig" ]; then
            FINAL="vendor/bengal-perf_defconfig"
          elif [ -f "arch/arm64/configs/vendor/bengal_defconfig" ]; then
            FINAL="vendor/bengal_defconfig"
          else
            # Берём любой с "bengal" в имени (если есть)
            FINAL=$(find arch/arm64/configs/ -type f -name "*bengal*defconfig" | head -1 | sed 's|arch/arm64/configs/||')
          fi

          if [ -z "$FINAL" ]; then
            echo "ОШИБКА: не удалось найти подходящий defconfig!"
            exit 1
          fi

          echo "Выбран defconfig: $FINAL"
          echo "FINAL_CONFIG=$FINAL" >> $GITHUB_OUTPUT

      - name: Build Kernel
        run: |
          cd $GITHUB_WORKSPACE/kernel_workspace/android-kernel
          CLANG_BIN=$GITHUB_WORKSPACE/kernel_workspace/clang/bin

          # Важно: НЕ добавляем CLANG_BIN в PATH, чтобы host-инструменты использовали системный gcc
          # Для кросс-компиляции ядра используем LLVM=1, а для host-программ явно указываем HOSTCC=gcc и HOSTLD=ld
          MAKE_ARGS="ARCH=arm64 O=out LLVM=1 LLVM_IAS=1 HOSTCC=gcc HOSTLD=ld"

          echo "=== Конфигурация ==="
          make $MAKE_ARGS ${{ steps.defconfig.outputs.FINAL_CONFIG }} V=1

          echo "=== Сборка ядра ==="
          make -j$(nproc) $MAKE_ARGS V=1

      - name: Prepare Kernel Image
        run: |
          cd $GITHUB_WORKSPACE/kernel_workspace
          # Проверяем наличие собранного образа
          IMAGE_PATH="android-kernel/out/arch/arm64/boot"
          if [ -f "$IMAGE_PATH/Image.gz-dtb" ]; then
            cp "$IMAGE_PATH/Image.gz-dtb" .
            echo "Image.gz-dtb найден"
          elif [ -f "$IMAGE_PATH/Image.gz" ]; then
            cp "$IMAGE_PATH/Image.gz" .
            echo "Image.gz найден"
          else
            echo "ОШИБКА: образ ядра не найден!"
            exit 1
          fi

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.KERNEL_ZIP_NAME }}
          path: ${{ github.workspace }}/kernel_workspace/Image.gz*
          if-no-files-found: error
